# Sampling Conformational Diversity to Predict Relative Protein-Ligand Binding Affinities Induced by Mutations in Few-Shot Learning

Our research investigates the resistance of ABL kinase and evaluates mutation-induced changes in binding free energy through data augmentation via subsampling with AlphaFold2 and deep learnings. 
To enhance feature representation, we developed an STGNet model, which utilizes Siamese networks to capture distinct structural features: ligand graphs, protein contact maps, and protein-ligand interaction graphs.

## The construction of the augmented pairwise dataset

Conformation ensembles are generated by subsampling AF2 for 31 ABL kinase mutants and wild-type. AutoDock Vina is used to dock each protein conformation with six TKI molecules, thereby obtaining docking score values for all mutant and wild-type conformations. The following figure illustrates in detail the process of constructing paired datasets for data augmentation. The selection of conformational data includes the top5, top50, and top100.

![dataset Image](https://github.com/AIMedDrug/STGNet/blob/main/notebook/top5/augmentedPairwiseDataset.png?raw=true)

## The structure representation of multimodal fusion deep learning model

The following is the architecture of the STGNet model. The reference data and the AF2-generated data are processed by the Siamese network to capture the feature difference. Protein contact maps and ligand graphs are processed by MPNN, and protein-ligand interaction graphs are processed by GIGN.

![model](https://github.com/AIMedDrug/STGNet/blob/main/notebook/top5/STGNet_model.png?raw=true)

## Structure and graph-aware Siamese network (STGNet) model protocol 

The steps required for STGNet are as follows:  (1) Build the augmented pairwise dataset. (2) Generate molecular maps, protein contact maps, and protein-ligand interaction maps for paired data; and split the data into training, validation, and test sets. (3) Train the model using Siamese networks for class three graphs.

Be aware: STGNet also can be used in other pairwise learning task.

We provide scripts for data processing and model training. If you are interested in STGNet, you can use the .py and .ipynb files.

We took top5 samples in data augmentation as an example, uploaded the source code to Git Hub, and can use Google Colab for testing.

**1 github**

github address: https://github.com/AIMedDrug/STGNet.git

**2 Google colab's .ipynb file address for testing**

(1) Direct Testing model

STGNet_test: https://colab.research.google.com/github/AIMedDrug/STGNet/blob/main/notebook/top5/STGNet_test.ipynb

(2) Gain predicted values for different TKIs

STGNet_getPredValue: https://colab.research.google.com/github/AIMedDrug/STGNet/blob/main/notebook/top5/STGNet_getPredValue.ipynb

(3) Evaluation: Obtain RMSE, MAE, Pearson coefficients, and Spearman coefficients for different TKIs

STGNet_pltMetrics: https://colab.research.google.com/github/AIMedDrug/STGNet/blob/main/notebook/top5/STGNet_pltMetrics.ipynb

## Other information

We have provided the relevant code in the STGNet/script directory on GitHub:

(1) Conduct docking and Otain the relative docking score
python docking.py

(2) Construct paired datasets for data augmentation
python formTupleData.py

(2.1) Build data file 1-dat file
python createTupleInterData.py

(2.2) Build feature file 2-pt file
python createFeatureTupleInterData.py

(3) Model training
python trainVal.py

(4) Generate predicted values
python getPredValue.py


We upload other data files to the Zenodo (https://zenodo.org/uploads/14607966), including the structure of the ligand, and the generated structures of the mutations from subsampled AF2.



## Experimental process

We provide a case study where k=2 for data augmentation. This case includes six stages, sperately: data preparation, data preprocessing, model training and validation, model testing, model prediction value processing, and model evaluation.

### Data Preparation

1. Graph features of ligand molecules

   Convert SMILES string to GCN graph feature representation.

2. ContactMap map features

   | abbr     | meaning                                                      |
   | -------- | ------------------------------------------------------------ |
   | conf_AF  | ContactMap two-dimensional matrix data calculated for k conformations of the same mutation type and k conformations corresponding to the wild type. |
   |          | Pdb files of k conformations of the same mutation type generated by AlphaFold2. |
   | conf_exp | ContactMap two-dimensional matrix data for the calculation of mutant single conformation and wild-type conformation. |
   |          | Mutated single conformation pdb file generated by AlphaFold2. |

   directory structure

   data

   ​	-af

   ​		-contact/\*.csv

   ​		-data_raw/unzip/Abl\*filtering_copy/pdb/\*.pdb

   ​	-exp

   ​		-pocket

   ​			-contact/\*.csv

   ​		-ABL_AlphaFold/\*/\*.pdb

3. Graph features of the interaction between mutations and ligand molecules

   | abbr     | meaning                                                      |
   | -------- | ------------------------------------------------------------ |
   | conf_AF  | Pdb and pdbqt files of ligand molecules generated by AutoDock docking of k conformations of the same mutation type with ligand molecules. |
   |          | Pdb and pdbqt files generated by AlphaFold2 for k conformations of the same mutation type. |
   | conf_exp | Mol2 file of ligand molecule generated by AutoDock docking between mutant single conformation and ligand molecule. |
   |          | Pdb and pdbqt files of mutant structures generated by AutoDock docking of mutant single conformations with ligand molecules. |

   directory structure

   data

   ​	-af

   ​		-autodock_Abl_new

   ​			-Abl_\*

   ​				Abl1\_\*\_vina_out.pdbqt

   ​				Abl1\_\*\_vina_out_temp.pdb

   ​		-data_raw

   ​			-unzip

   ​				-Abl\_\*\_filtering_copy

   ​					-pdb

   ​						molde_\*\_pocket.pdbqt

   ​						model_\*\_pocket.pdb

   ​	-exp

   ​		-autoDockScript_small

   ​			-docked/\*/\*_vina_output.mol2

   ​			-aligned

   ​				-\*

   ​					-\*_pocket.pdbqt

   ​					-\*_pocket.pdb

### Data Preprocessing

1. Read the CSV file of the Gaussian distribution mean of free energy calculated for mutant and wild-type, select the top k terms with the smallest absolute interpolation from the Gaussian mean for pairing, and achieve data augmentation.

   ```python
   python STGNet_01_data_augmetation_gaussian_top2.py
   ```

2. Generate data file dat. Firstly, the data will be unified and merged, including the tag names of conf_exp and conf_AF, ligand small molecules, mutation sequences, and other related information , such as ΔΔΔG<sub>cal</sub>  、ΔΔG<sub>dock</sub>、ΔΔG<sub>exp</sub>. Further divide the integrated data into training set, validation set, and testing set.

   ```python
   python STGNet_02_generate_dataset_1.py
   ```

3. Generate data file pt. This method will obtain the files required for model training, validation, and testing. We have defined a subclass of PyTorch Geometric InCacheDataset, namely formDatasetTwin_muts_inter.

   The feature processing is as follows：

   （1）The graph structures of small molecules corresponding to conf_exp and conf_AF.

   （2）The graph structure of the contactMap corresponding to conf_exp and conf_AF.

   （3）The graphical structure of the interaction between mutations corresponding to conf_exp and conf_AF and small molecules.

   ```python
   python STGNet_03_generate_dataset_2.py
   ```

### Model Training and Validation

```
python STGNet_04_train_val_model.py
```

### Model Testing

During the model testing phase, it is possible to obtain the predicted values of ΔΔΔG<sub>cal</sub>.

```python
python STGNet_05_test_model.py
```

### Model Prediction Value Processing

The conf_exp labeling of the same mutant-ligand corresponds to the predicted values of multiple conf_AF different conformations, and   such a computational process eliminates errors in the docking data. The prediction   averaged over multiple conf_AF tags corresponding to the conf_exp tag for the same mutation and ligand, to calculate a single predicted free energy value for each mutation. The single value   and the experimental value   are used together for the performance evaluation of the model.

```python
python STGNet_06_getPredValue.py
```

### Model Evaluation

We evaluate the performance of the model using RMSE, MAE, Pearson, and Spearman.

```python
python STGNet_07_pltMetrics.py
```



